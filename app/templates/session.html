{% extends "base.html" %}

{% block title %}{{ session.title }} - VibeLyrics{% endblock %}

{% block content %}
<div class="session-container">
    <!-- Session Header -->
    <div class="session-header-bar tw-backdrop-blur-md tw-border-b tw-border-white/10">
        <div class="session-info">
            <a href="{{ url_for('workspace.index') }}" class="back-link">‚Üê Back</a>
            <h1 class="session-title" contenteditable="true" data-session-id="{{ session.id }}">{{ session.title }}</h1>
            <div class="session-badges">
                <span class="bpm-badge large">{{ session.bpm }} BPM</span>
            </div>
        </div>
        <div class="session-actions">
            {% if not session.audio_path %}
            <button class="btn btn-secondary small" onclick="document.getElementById('audio-upload').click()">üéµ Add
                Beat</button>
            <input type="file" id="audio-upload" style="display:none" accept="audio/*" onchange="uploadAudio(this)">
            {% endif %}
            <button class="btn btn-secondary tw-transition-all tw-duration-200 hover:tw-shadow-glow-cyan"
                onclick="analyzeSession()">üìä Analyze</button>
            <select id="provider-select" class="input small" onchange="switchProvider(this.value)">
                <option value="openai" {% if profile.preferred_provider=='openai' %}selected{% endif %}>OpenAI</option>
                <option value="gemini" {% if profile.preferred_provider=='gemini' %}selected{% endif %}>Gemini</option>
                <option value="perplexity" {% if profile.preferred_provider=='perplexity' %}selected{% endif %}>
                    Perplexity</option>
            </select>
            <div class="export-dropdown" style="position:relative;" x-data="{ open: false }">
                <button class="btn btn-secondary" @click="open = !open">üìÑ Export ‚ñæ</button>
                <div id="export-menu" class="dropdown-menu" x-show="open" @click.outside="open = false"
                    x-transition:enter="transition ease-out duration-100" x-transition:enter-start="opacity-0 scale-95"
                    x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-75"
                    x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
                    style="position:absolute; right:0; top:100%; background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; min-width:180px; z-index:100; margin-top:4px;">
                    <a href="{{ url_for('export.export_txt', session_id=session.id) }}" class="dropdown-item"
                        style="display:block; padding:0.75rem 1rem; color:var(--text-primary); text-decoration:none;">üìù
                        Plain Text (.txt)</a>
                    <a href="{{ url_for('export.export_pdf', session_id=session.id) }}" class="dropdown-item"
                        style="display:block; padding:0.75rem 1rem; color:var(--text-primary); text-decoration:none;">üìÑ
                        Styled PDF</a>
                    <a href="{{ url_for('export.export_teleprompter', session_id=session.id) }}" target="_blank"
                        class="dropdown-item"
                        style="display:block; padding:0.75rem 1rem; color:var(--text-primary); text-decoration:none;">üì∫
                        Teleprompter</a>
                    <a href="{{ url_for('export.export_json', session_id=session.id) }}" class="dropdown-item"
                        style="display:block; padding:0.75rem 1rem; color:var(--text-primary); text-decoration:none;">üíæ
                        Backup (JSON)</a>
                    <a href="{{ url_for('workspace.export_print', session_id=session.id) }}" target="_blank"
                        class="dropdown-item"
                        style="display:block; padding:0.75rem 1rem; color:var(--text-primary); text-decoration:none; border-top:1px solid var(--border-color);">üñ®Ô∏è
                        Print View</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Waveform Audio Player -->
    {% if session.audio_path %}
    <div class="waveform-player-container">
        <div id="waveform-container"></div>
        <div class="waveform-controls">
            <button class="btn btn-primary small" onclick="waveformPlayer.playPause()" id="play-btn">‚ñ∂Ô∏è Play</button>
            <span id="waveform-time">0:00 / 0:00</span>
            <div class="loop-controls">
                <button class="btn btn-secondary small" onclick="waveformPlayer.setLoopStart()"
                    title="Set loop start">üÖ∞Ô∏è</button>
                <button class="btn btn-secondary small" onclick="waveformPlayer.setLoopEnd()"
                    title="Set loop end">üÖ±Ô∏è</button>
                <button class="btn btn-secondary small" onclick="waveformPlayer.clearLoop()"
                    title="Clear loop">‚ùå</button>
                <span id="loop-info"></span>
            </div>
            <div class="speed-controls">
                <label>Speed:</label>
                <select id="speed-select" class="input small"
                    onchange="waveformPlayer.setSpeed(parseFloat(this.value))">
                    <option value="0.5">0.5x</option>
                    <option value="0.75">0.75x</option>
                    <option value="1" selected>1x</option>
                    <option value="1.25">1.25x</option>
                    <option value="1.5">1.5x</option>
                </select>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Flow Visualization -->
    <div class="flow-viz-container">
        <canvas id="flow-canvas"></canvas>
    </div>

    <!-- Main Writing Area -->
    <div class="writing-area" id="writing-area">
        <!-- RhymeWave Panel (Left Side) -->
        <div class="rhymewave-panel" id="rhymewave-panel" style="display: none;">
            <div class="reference-header">
                <h3>üåä RhymeWave</h3>
                <div class="reference-controls">
                    <button class="btn-icon" onclick="toggleRhymeWavePanel()" title="Close RhymeWave">‚úï</button>
                </div>
            </div>
            <div class="rhymewave-content" style="flex: 1; overflow: hidden;">
                <iframe id="rhymewave-iframe" src=""
                    style="width:100%; height:100%; border:none; background:white;"></iframe>
            </div>
        </div>

        <!-- AI Help Panel (Left Side) -->
        <div class="ai-help-panel" id="ai-help-panel" style="display: none;">
            <div class="reference-header">
                <h3>ü§ñ AI Help</h3>
                <div class="reference-controls">
                    <button class="btn-icon" onclick="toggleAIHelpPanel()" title="Close AI Help">‚úï</button>
                </div>
            </div>
            <div class="ai-help-content" style="flex: 1; padding: 1rem; overflow-y: auto;">
                <!-- Improvement Section -->
                <div class="ai-section" id="improvement-section-left">
                    <h4>‚ú® Improve Line</h4>
                    <div class="improvement-types">
                        <button class="chip active" data-type="rhyme" onclick="setImprovementType('rhyme')">üéØ
                            Rhyme</button>
                        <button class="chip" data-type="flow" onclick="setImprovementType('flow')">üåä Flow</button>
                        <button class="chip" data-type="wordplay" onclick="setImprovementType('wordplay')">üî§
                            Wordplay</button>
                        <button class="chip" data-type="depth" onclick="setImprovementType('depth')">üíé Depth</button>
                    </div>
                    <div class="improvement-result" id="improvement-result-left"></div>
                </div>
                <!-- Ask AI -->
                <div class="ai-section" style="margin-top: 1rem;">
                    <h4>üí¨ Ask AI</h4>
                    <div class="ask-input-row">
                        <input type="text" id="ask-input-left" class="input" placeholder="Ask about rhymes, flow...">
                        <button class="btn btn-primary" onclick="askAIFromLeft()">Ask</button>
                    </div>
                    <div class="ask-response" id="ask-response-left"></div>
                </div>
            </div>
        </div>

        <!-- Floating Toggle Buttons (Left Side) -->
        <div class="left-toggle-buttons">
            <button class="split-view-toggle" id="rhymewave-toggle" onclick="toggleRhymeWavePanel()"
                title="Toggle RhymeWave">
                üåä
            </button>
            <button class="split-view-toggle ai-toggle" id="ai-help-toggle" onclick="toggleAIHelpPanel()"
                title="Toggle AI Help">
                ü§ñ
            </button>
        </div>

        <!-- Lyrics Panel -->
        <div class="lyrics-panel">
            <div class="lines-container" id="lines-container">
                {% set current_section = 'Verse' %}
                {% for line in lines %}
                {% if loop.first or (line.section and line.section != current_section) %}
                {% set current_section = line.section %}
                <div class="section-divider">
                    <span class="section-label">{{ line.section }}</span>
                </div>
                {% endif %}
                <div class="line-row tw-transition-all tw-duration-200 hover:tw-translate-x-1 {{ line.heatmap_class }}"
                    data-line-id="{{ line.id }}" data-line-number="{{ line.line_number }}">
                    <span class="line-number">{{ line.line_number }}</span>
                    <div class="line-content">
                        <span class="line-text" oncontextmenu="handleWordRightClick(event)">{{ line.highlighted_html |
                            default(line.final_version or
                            line.user_input) | safe }}</span>
                        <div class="line-meta">
                            <span class="syllable-count" title="Syllable count">{{ line.syllable_count }} syl</span>
                            {% if line.has_internal_rhyme %}<span class="rhyme-badge"
                                title="Has internal rhyme">üîó</span>{% endif %}
                            {% if line.was_corrected %}<span class="corrected-badge"
                                title="You modified AI suggestion">‚úèÔ∏è</span>{% endif %}
                        </div>
                    </div>
                    <div class="line-actions">
                        <button class="btn-icon edit-btn" data-line-id="{{ line.id }}"
                            data-line-text="{{ line.final_version or line.user_input }}"
                            onclick="editLine(this.dataset.lineId, this.dataset.lineText)"
                            title="Edit this line">‚úèÔ∏è</button>
                        <button class="btn-icon improve-btn" data-line-id="{{ line.id }}"
                            data-line-text="{{ line.final_version or line.user_input }}"
                            onclick="improveLine(this.dataset.lineId, this.dataset.lineText)"
                            title="Improve this line">‚ú®</button>
                        <button class="btn-icon delete-btn" data-line-id="{{ line.id }}"
                            onclick="deleteLine(this.dataset.lineId)" title="Delete this line">üóëÔ∏è</button>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Input Area -->
            <div class="input-area">
                <div class="section-controls">
                    <select id="section-select" class="input small" style="width:auto;">
                        <option value="Verse">Verse</option>
                        <option value="Chorus">Chorus</option>
                        <option value="Bridge">Bridge</option>
                        <option value="Intro">Intro</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div class="input-row">
                    <span class="line-number">{{ (lines|length) + 1 }}</span>
                    <div class="autocomplete-wrapper">
                        <input type="text" id="new-line-input" class="line-input" placeholder="Write your next bar..."
                            data-session-id="{{ session.id }}" autocomplete="off">
                        <span class="ghost-text" id="ghost-text"></span>
                    </div>
                    <div class="input-actions">
                        <button class="btn btn-primary" onclick="addLine()">Add</button>
                    </div>
                </div>
                <div class="input-hint" id="input-hint">
                    <span class="syllable-counter">0 syllables</span>
                    <span class="hint-text" id="tab-hint" style="display:none;">Press <kbd>Tab</kbd> to accept</span>
                </div>
            </div>
        </div>

        <!-- AI Panel (collapsible) - Word Lookup Only -->
        <div class="ai-panel" id="ai-panel" x-data="sidebarPanel" :class="{ 'active': $store.aiPanel.open }">
            <div class="ai-header">
                <div class="sidebar-tabs">
                    <button class="tab-btn active">üìö Word Lookup</button>
                </div>
                <div class="ai-panel-controls">
                    <button class="btn-icon" @click="$store.aiPanel.toggle()">‚úï</button>
                </div>
            </div>

            <div class="ai-content">
                <!-- Word Lookup Panel -->
                <div class="ai-section" id="lookup-section">
                    <div id="lookup-word-header"
                        style="font-weight:bold; color:var(--accent-primary); margin-bottom:0.5rem;"></div>
                    <div id="lookup-results" style="max-height:400px; overflow-y:auto;">
                        <p class="placeholder-text">Right-click a word in your lyrics to look up rhymes or synonyms.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Power Tools Context Menu -->
<div id="context-menu" class="context-menu"
    style="display:none; position:absolute; z-index:1000; background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.5); width:200px;">
    <ul style="list-style:none; padding:0; margin:0;">
        <li style="padding:0.5rem 1rem; cursor:pointer;" onclick="lookupWord('rhyme')">üîç Find Rhymes</li>
        <li style="padding:0.5rem 1rem; cursor:pointer;" onclick="lookupWord('synonym')">üîÅ Synonyms</li>
    </ul>
</div>

<!-- Analysis Modal -->
<div class="modal" id="analysis-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üìä Session Analysis</h2>
            <button class="btn-icon" onclick="closeModal('analysis-modal')">‚úï</button>
        </div>
        <div class="modal-body" id="analysis-content">
            Loading...
        </div>
    </div>
</div>
</div>

<div id="session-data" data-session-id="{{ session.id }}" data-bpm="{{ session.bpm }}" style="display:none;"></div>
<script>
    const sessionData = document.getElementById('session-data');
    const SESSION_ID = parseInt(sessionData.dataset.sessionId);
    const BPM = parseInt(sessionData.dataset.bpm);
    let currentImprovementType = 'rhyme';
    let currentLineToImprove = null;
    let selectedWord = "";

    // Alpine.js Store for AI Panel state (global access)
    document.addEventListener('alpine:init', () => {
        Alpine.store('aiPanel', {
            open: false,
            toggle() { this.open = !this.open; }
        });
    });

    // Legacy function wrappers for button onclick handlers
    function openAIHelp() {
        toggleAIHelpPanel();
    }

    function openRhymeWave() {
        toggleRhymeWavePanel();
    }

    // Toggle RhymeWave Panel (Left Side)
    function toggleRhymeWavePanel() {
        const writingArea = document.getElementById('writing-area');
        const panel = document.getElementById('rhymewave-panel');
        const toggle = document.getElementById('rhymewave-toggle');
        const iframe = document.getElementById('rhymewave-iframe');

        // Close AI Help panel if open
        if (writingArea.classList.contains('ai-help-mode')) {
            toggleAIHelpPanel();
        }

        if (writingArea.classList.contains('rhymewave-mode')) {
            writingArea.classList.remove('rhymewave-mode');
            panel.style.display = 'none';
            toggle.classList.remove('active');
            iframe.src = ''; // Unload iframe when closed
        } else {
            writingArea.classList.add('rhymewave-mode');
            panel.style.display = 'flex';
            toggle.classList.add('active');
            iframe.src = 'https://rhymewave.com'; // Load iframe when opened
        }
    }

    // Toggle AI Help Panel (Left Side)
    function toggleAIHelpPanel() {
        const writingArea = document.getElementById('writing-area');
        const panel = document.getElementById('ai-help-panel');
        const toggle = document.getElementById('ai-help-toggle');

        // Close RhymeWave panel if open
        if (writingArea.classList.contains('rhymewave-mode')) {
            toggleRhymeWavePanel();
        }

        if (writingArea.classList.contains('ai-help-mode')) {
            writingArea.classList.remove('ai-help-mode');
            panel.style.display = 'none';
            toggle.classList.remove('active');
        } else {
            writingArea.classList.add('ai-help-mode');
            panel.style.display = 'flex';
            toggle.classList.add('active');
        }
    }

    // Ask AI from left panel
    async function askAIFromLeft() {
        const input = document.getElementById('ask-input-left');
        const responseDiv = document.getElementById('ask-response-left');
        const question = input.value.trim();

        if (!question) return;

        responseDiv.innerHTML = '<p>Thinking...</p>';

        try {
            const result = await apiCall('/api/ask', 'POST', {
                question: question,
                session_id: SESSION_ID
            });

            if (result.success) {
                responseDiv.innerHTML = `<div class="ai-answer">${escapeHtml(result.answer)}</div>`;
                input.value = '';
            } else {
                responseDiv.innerHTML = `<p class="error">${result.error}</p>`;
            }
        } catch (e) {
            responseDiv.innerHTML = `<p class="error">Error: ${e.message}</p>`;
        }
    }

    // toggleAIPanel kept for backwards compatibility
    function toggleAIPanel() {
        Alpine.store('aiPanel').toggle();
    }

    function handleWordRightClick(e) {
        e.preventDefault();
        const selection = window.getSelection();
        selectedWord = selection.toString().trim();
        if (!selectedWord) return;

        const menu = document.getElementById('context-menu');
        menu.style.display = 'block';
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';
    }

    document.addEventListener('click', () => {
        document.getElementById('context-menu').style.display = 'none';
    });

    async function lookupWord(type) {
        if (!selectedWord) return;

        // Show AI panel using Alpine store
        Alpine.store('aiPanel').open = true;

        // Update lookup header
        const header = document.getElementById('lookup-word-header');
        header.textContent = `${type === 'rhyme' ? 'üéØ Rhymes' : 'üîÅ Synonyms'} for "${selectedWord}"`;

        // Fetch results
        const res = await fetch(`/api/tools/lookup?word=${encodeURIComponent(selectedWord)}&type=${type}`);
        const data = await res.json();

        // Display in panel
        const resultsDiv = document.getElementById('lookup-results');
        let html = '';

        if (type === 'rhyme') {
            const rhymes = data.results?.perfect || data.results || [];
            if (rhymes.length > 0) {
                html = `<div class="lookup-tags" style="display:flex; flex-wrap:wrap; gap:0.5rem;">
                    ${rhymes.slice(0, 20).map(r => `<span class="chip" style="cursor:pointer;" onclick="insertWord('${r}')">${r}</span>`).join('')}
                </div>`;
            } else {
                html = '<p style="color:var(--text-secondary);">No rhymes found.</p>';
            }
        } else {
            const synonyms = data.results?.synonyms || data.results || [];
            if (synonyms.length > 0) {
                html = `<div class="lookup-tags" style="display:flex; flex-wrap:wrap; gap:0.5rem;">
                    ${synonyms.slice(0, 20).map(s => `<span class="chip" style="cursor:pointer;" onclick="insertWord('${s}')">${s}</span>`).join('')}
                </div>`;
            } else {
                html = '<p style="color:var(--text-secondary);">No synonyms found.</p>';
            }
        }

        resultsDiv.innerHTML = html;
    }

    function insertWord(word) {
        const input = document.getElementById('new-line-input');
        if (input) {
            input.value += (input.value ? ' ' : '') + word;
            input.focus();
        }
    }

    // Export menu now handled by Alpine.js x-data and @click.outside

    // ============================================
    // SPLIT VIEW MODE
    // ============================================
    let splitViewActive = false;

    function toggleSplitView() {
        splitViewActive = !splitViewActive;
        const panel = document.getElementById('reference-panel');
        const writingArea = document.getElementById('writing-area');
        const toggle = document.getElementById('split-toggle');

        if (splitViewActive) {
            panel.style.display = 'flex';
            writingArea.classList.add('split-mode');
            toggle.classList.add('active');
            loadReferenceOptions();
        } else {
            panel.style.display = 'none';
            writingArea.classList.remove('split-mode');
            toggle.classList.remove('active');
        }
    }

    async function loadReferenceOptions() {
        const select = document.getElementById('reference-select');

        try {
            // Load saved sessions as references
            const res = await fetch('/api/sessions');
            if (res.ok) {
                const data = await res.json();
                const sessions = data.sessions || [];

                // Clear existing options
                select.innerHTML = '<option value="">Select reference...</option>';

                sessions.forEach(s => {
                    if (s.id !== SESSION_ID) {
                        const opt = document.createElement('option');
                        opt.value = `session:${s.id}`;
                        opt.textContent = `üìù ${s.title}`;
                        select.appendChild(opt);
                    }
                });
            }
        } catch (e) {
            console.log('Could not load references:', e);
        }
    }

    async function loadReference(value) {
        const content = document.getElementById('reference-content');
        const actions = document.getElementById('reference-actions');

        if (!value) {
            content.innerHTML = '<p class="placeholder-text">Select a reference to view lyrics side-by-side.</p>';
            actions.style.display = 'none';
            return;
        }

        const [type, id] = value.split(':');

        if (type === 'session') {
            try {
                const res = await fetch(`/export/${id}/json`);
                const data = await res.json();

                let html = `<div class="reference-title">${data.title}</div>`;
                html += '<div class="reference-lines">';

                let currentSection = '';
                data.lines.forEach(line => {
                    if (line.section !== currentSection) {
                        currentSection = line.section;
                        html += `<div class="ref-section">[${currentSection}]</div>`;
                    }
                    html += `<div class="ref-line" onclick="copyToInput('${line.text.replace(/'/g, "\\'")}')">${line.text}</div>`;
                });

                html += '</div>';
                content.innerHTML = html;
                actions.style.display = 'block';
            } catch (e) {
                content.innerHTML = '<p class="error">Failed to load reference.</p>';
            }
        }
    }

    function copyToInput(text) {
        const input = document.getElementById('new-line-input');
        if (input) {
            input.value = text;
            input.focus();
            showToast('Line copied to input', 'success');
        }
    }

    // ============================================
    // STYLE SELECTOR
    // ============================================
    let currentStyle = '';

    async function loadStyleOptions() {
        try {
            const res = await fetch('/api/styles');
            const data = await res.json();

            if (data.success) {
                const container = document.getElementById('style-selector');
                if (container) {
                    let html = '<option value="">Your Style</option>';
                    for (const [key, style] of Object.entries(data.styles)) {
                        html += `<option value="${key}">${style.icon} ${style.name}</option>`;
                    }
                    container.innerHTML = html;
                }
            }
        } catch (e) {
            console.log('Could not load styles');
        }
    }

    function setStyle(styleKey) {
        currentStyle = styleKey;
        showToast(styleKey ? `Style: ${styleKey}` : 'Using your style', 'info');
    }

    // Load styles on page load
    document.addEventListener('DOMContentLoaded', loadStyleOptions);

    async function uploadAudio(input) {
        if (!input.files[0]) return;

        // Show loading state
        const btn = document.querySelector('button[onclick*="audio-upload"]');
        if (btn) btn.textContent = '‚è≥ Uploading...';

        const formData = new FormData();
        formData.append('audio_file', input.files[0]);

        try {
            const res = await fetch(`/session/${SESSION_ID}/upload_audio`, {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            if (data.success) {
                alert('Audio uploaded successfully! BPM detection is running in the background.');
                location.reload();
            } else {
                alert('Upload failed: ' + (data.error || 'Unknown error'));
                if (btn) btn.textContent = 'üéµ Add Beat';
                input.value = ''; // Reset input
            }
        } catch (e) {
            console.error('Upload error:', e);
            alert('Upload failed: ' + e.message);
            if (btn) btn.textContent = 'üéµ Add Beat';
            input.value = '';
        }
    }
</script>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script src="https://unpkg.com/wavesurfer.js@7"></script>
<script src="{{ url_for('static', filename='js/waveform_player.js') }}"></script>
<script src="{{ url_for('static', filename='js/flow_viz.js') }}"></script>
<script src="{{ url_for('static', filename='js/alpine-components.js') }}"></script>
<script src="{{ url_for('static', filename='js/session.js') }}"></script>
<script>
    // Init Flow Viz
    try {
        const viz = new FlowVisualizer('flow-canvas');
        const linesDataEl = document.getElementById('lines-data-json');
        if (linesDataEl) {
            const linesData = JSON.parse(linesDataEl.textContent);
            viz.update(linesData);
        }
    } catch (e) {
        console.error('Flow Viz Init Error:', e);
    }

    // Init Waveform Player if audio exists
    {% if session.audio_path %}
    try {
        // Wait for WaveSurfer to load
        if (typeof WaveSurfer !== 'undefined') {
            initWaveformPlayer('waveform-container', '{{ url_for("static", filename=session.audio_path) }}');
        } else {
            console.error('WaveSurfer library not loaded');
        }
    } catch (e) {
        console.error('Waveform Player Init Error:', e);
    }
    {% endif %}
</script>
<script type="application/json" id="lines-data-json">
[
    {% for line in lines %}
    { "syllable_count": {{ line.syllable_count or 0 }} }{% if not loop.last %},{% endif %}
    {% endfor %}
]
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}{{ session.title }} - VibeLyrics{% endblock %}

{% block content %}
<div class="session-container">
    <!-- Session Header -->
    <div class="session-header-bar">
        <div class="session-info">
            <a href="{{ url_for('workspace.index') }}" class="back-link">â† Back</a>
            <h1 class="session-title" contenteditable="true" data-session-id="{{ session.id }}">{{ session.title }}</h1>
            <div class="session-badges">
                <span class="bpm-badge large">{{ session.bpm }} BPM</span>
            </div>
        </div>
        <div class="session-actions">
            {% if not session.audio_path %}
            <button class="btn btn-secondary small" onclick="document.getElementById('audio-upload').click()">ğŸµ Add
                Beat</button>
            <input type="file" id="audio-upload" style="display:none" accept="audio/*" onchange="uploadAudio(this)">
            {% endif %}
            <button class="btn btn-secondary" onclick="analyzeSession()">ğŸ“Š Analyze</button>
            <button class="btn btn-secondary" onclick="toggleAIPanel()">ğŸ¤– AI Help</button>
            <select id="provider-select" class="input small" onchange="switchProvider(this.value)">
                <option value="openai" {% if profile.preferred_provider=='openai' %}selected{% endif %}>OpenAI</option>
                <option value="gemini" {% if profile.preferred_provider=='gemini' %}selected{% endif %}>Gemini</option>
                <option value="perplexity" {% if profile.preferred_provider=='perplexity' %}selected{% endif %}>
                    Perplexity</option>
            </select>
            <a href="{{ url_for('workspace.export_print', session_id=session.id) }}" target="_blank"
                class="btn btn-secondary">ğŸ“„ Export</a>
        </div>
    </div>

    <!-- Waveform Audio Player -->
    {% if session.audio_path %}
    <div class="waveform-player-container"
        style="background:var(--bg-card); border-bottom:1px solid var(--border-color); padding:1rem;">
        <div id="waveform-container" style="width:100%; height:80px; margin-bottom:0.5rem;"></div>
        <div class="waveform-controls" style="display:flex; align-items:center; gap:1rem; flex-wrap:wrap;">
            <button class="btn btn-primary small" onclick="waveformPlayer.playPause()" id="play-btn">â–¶ï¸ Play</button>
            <span id="waveform-time" style="font-family:monospace; color:var(--text-secondary);">0:00 / 0:00</span>
            <div class="loop-controls" style="display:flex; gap:0.5rem; align-items:center;">
                <button class="btn btn-secondary small" onclick="waveformPlayer.setLoopStart()"
                    title="Set loop start">ğŸ…°ï¸</button>
                <button class="btn btn-secondary small" onclick="waveformPlayer.setLoopEnd()"
                    title="Set loop end">ğŸ…±ï¸</button>
                <button class="btn btn-secondary small" onclick="waveformPlayer.clearLoop()"
                    title="Clear loop">âŒ</button>
                <span id="loop-info" style="font-size:0.85rem; color:var(--accent-primary);"></span>
            </div>
            <div class="speed-controls" style="display:flex; align-items:center; gap:0.5rem;">
                <label style="font-size:0.85rem; color:var(--text-secondary);">Speed:</label>
                <select id="speed-select" class="input small" style="width:auto;"
                    onchange="waveformPlayer.setSpeed(parseFloat(this.value))">
                    <option value="0.5">0.5x</option>
                    <option value="0.75">0.75x</option>
                    <option value="1" selected>1x</option>
                    <option value="1.25">1.25x</option>
                    <option value="1.5">1.5x</option>
                </select>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Flow Visualization -->
    <div class="flow-viz-container"
        style="background:var(--bg-card); border-bottom:1px solid var(--border-color); height:100px; width:100%; position:relative;">
        <canvas id="flow-canvas" style="width:100%; height:100%; display:block;"></canvas>
    </div>

    <!-- Main Writing Area -->
    <div class="writing-area">
        <!-- Lyrics Panel -->
        <div class="lyrics-panel">
            <div class="lines-container" id="lines-container">
                {% set current_section = 'Verse' %}
                {% for line in lines %}
                {% if loop.first or (line.section and line.section != current_section) %}
                {% set current_section = line.section %}
                <div class="section-divider">
                    <span class="section-label">{{ line.section }}</span>
                </div>
                {% endif %}
                <div class="line-row {{ line.heatmap_class }}" data-line-id="{{ line.id }}"
                    data-line-number="{{ line.line_number }}">
                    <span class="line-number">{{ line.line_number }}</span>
                    <div class="line-content">
                        <span class="line-text" oncontextmenu="handleWordRightClick(event)">{{ line.highlighted_html |
                            default(line.final_version or
                            line.user_input) | safe }}</span>
                        <div class="line-meta">
                            <span class="syllable-count" title="Syllable count">{{ line.syllable_count }} syl</span>
                            {% if line.has_internal_rhyme %}<span class="rhyme-badge"
                                title="Has internal rhyme">ğŸ”—</span>{% endif %}
                            {% if line.was_corrected %}<span class="corrected-badge"
                                title="You modified AI suggestion">âœï¸</span>{% endif %}
                        </div>
                    </div>
                    <div class="line-actions">
                        <button class="btn-icon edit-btn" data-line-id="{{ line.id }}"
                            data-line-text="{{ line.final_version or line.user_input }}"
                            onclick="editLine(this.dataset.lineId, this.dataset.lineText)"
                            title="Edit this line">âœï¸</button>
                        <button class="btn-icon improve-btn" data-line-id="{{ line.id }}"
                            data-line-text="{{ line.final_version or line.user_input }}"
                            onclick="improveLine(this.dataset.lineId, this.dataset.lineText)"
                            title="Improve this line">âœ¨</button>
                        <button class="btn-icon delete-btn" data-line-id="{{ line.id }}"
                            onclick="deleteLine(this.dataset.lineId)" title="Delete this line">ğŸ—‘ï¸</button>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Input Area -->
            <div class="input-area">
                <div class="section-controls" style="margin-bottom:0.5rem; display:flex; gap:0.5rem;">
                    <select id="section-select" class="input small" style="width:auto;">
                        <option value="Verse">Verse</option>
                        <option value="Chorus">Chorus</option>
                        <option value="Bridge">Bridge</option>
                        <option value="Intro">Intro</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div class="input-row">
                    <span class="line-number">{{ (lines|length) + 1 }}</span>
                    <div class="autocomplete-wrapper">
                        <input type="text" id="new-line-input" class="line-input" placeholder="Write your next bar..."
                            data-session-id="{{ session.id }}" autocomplete="off">
                        <span class="ghost-text" id="ghost-text"></span>
                    </div>
                    <div class="input-actions">
                        <button class="btn btn-primary" onclick="addLine()">Add</button>
                    </div>
                </div>
                <div class="input-hint" id="input-hint">
                    <span class="syllable-counter">0 syllables</span>
                    <span class="hint-text" id="tab-hint" style="display:none;">Press <kbd>Tab</kbd> to accept</span>
                </div>
            </div>
        </div>

        <!-- AI Panel (collapsible) -->
        <div class="ai-panel" id="ai-panel">
            <div class="ai-header" style="padding-bottom: 0;">
                <div class="sidebar-tabs"
                    style="display:flex; gap:10px; border-bottom:1px solid var(--border-color); width:100%;">
                    <button class="tab-btn active" onclick="switchSidebarTab('ai')"
                        style="background:none; border:none; color:var(--text-primary); padding:10px; border-bottom:2px solid var(--accent-primary); cursor:pointer;">ğŸ¤–
                        AI Tools</button>
                    <button class="tab-btn" onclick="switchSidebarTab('rhymewave')"
                        style="background:none; border:none; color:var(--text-secondary); padding:10px; cursor:pointer;">ğŸŒŠ
                        RhymeWave</button>
                    <button class="btn-icon" onclick="toggleAIPanel()" style="margin-left:auto;">âœ•</button>
                </div>
            </div>

            <div class="sidebar-content-wrapper" style="height: calc(100% - 50px); overflow-y: auto;">
                <!-- AI Tools Tab -->
                <div id="tab-ai" class="sidebar-tab-content">
                    <div class="ai-content">
                        <!-- Suggestion Area -->
                        <div class="ai-section" id="suggestion-section">
                            <h4>Suggestions</h4>
                            <div class="suggestions-list" id="suggestions-list">
                                <p class="placeholder-text">Write a line and click "Suggest" to get AI suggestions for
                                    the next bar.</p>
                            </div>
                        </div>

                        <!-- Improvement Area -->
                        <div class="ai-section" id="improvement-section">
                            <h4>Improve Line</h4>
                            <div class="improvement-types">
                                <button class="chip" data-type="rhyme" onclick="setImprovementType('rhyme')">ğŸ¯
                                    Rhyme</button>
                                <button class="chip" data-type="flow" onclick="setImprovementType('flow')">ğŸŒŠ
                                    Flow</button>
                                <button class="chip" data-type="wordplay" onclick="setImprovementType('wordplay')">ğŸ§ 
                                    Wordplay</button>
                                <button class="chip" data-type="depth" onclick="setImprovementType('depth')">ğŸ’
                                    Depth</button>
                            </div>
                            <div class="improvement-result" id="improvement-result"></div>
                        </div>

                        <!-- Ask AI -->
                        <div class="ai-section">
                            <h4>Ask AI</h4>
                            <div class="ask-input-row">
                                <input type="text" id="ask-input" class="input"
                                    placeholder="Ask about rhymes, flow, technique...">
                                <button class="btn btn-primary" onclick="askAI()">Ask</button>
                            </div>
                            <div class="ask-response" id="ask-response"></div>
                        </div>

                        <!-- Word Lookup Panel -->
                        <div class="ai-section" id="lookup-section">
                            <h4>ğŸ“š Word Lookup</h4>
                            <div id="lookup-word-header"
                                style="font-weight:bold; color:var(--accent-primary); margin-bottom:0.5rem;"></div>
                            <div id="lookup-results" style="max-height:200px; overflow-y:auto;">
                                <p class="placeholder-text">Right-click a word in your lyrics to look up rhymes or
                                    synonyms.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RhymeWave Tab -->
                <div id="tab-rhymewave" class="sidebar-tab-content" style="display:none; height:100%;">
                    <iframe src="https://rhymewave.com"
                        style="width:100%; height:100%; border:none; background:white;"></iframe>
                </div>
            </div>
        </div>

        <!-- Power Tools Context Menu -->
        <div id="context-menu" class="context-menu"
            style="display:none; position:absolute; z-index:1000; background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.5); width:200px;">
            <ul style="list-style:none; padding:0; margin:0;">
                <li style="padding:0.5rem 1rem; cursor:pointer;" onclick="lookupWord('rhyme')">ğŸ” Find Rhymes</li>
                <li style="padding:0.5rem 1rem; cursor:pointer;" onclick="lookupWord('synonym')">ğŸ” Synonyms</li>
            </ul>
        </div>

        <!-- Analysis Modal -->
        <div class="modal" id="analysis-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>ğŸ“Š Session Analysis</h2>
                    <button class="btn-icon" onclick="closeModal('analysis-modal')">âœ•</button>
                </div>
                <div class="modal-body" id="analysis-content">
                    Loading...
                </div>
            </div>
        </div>
    </div>

    <div id="session-data" data-session-id="{{ session.id }}" data-bpm="{{ session.bpm }}" style="display:none;"></div>
    <script>
        const sessionData = document.getElementById('session-data');
        const SESSION_ID = parseInt(sessionData.dataset.sessionId);
        const BPM = parseInt(sessionData.dataset.bpm);
        let currentImprovementType = 'rhyme';
        let currentLineToImprove = null;
        let selectedWord = "";

        function switchSidebarTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.sidebar-tab-content').forEach(el => el.style.display = 'none');
            // Deactivate all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.borderBottom = 'none';
                btn.style.color = 'var(--text-secondary)';
            });

            // Show selected tab
            document.getElementById('tab-' + tabName).style.display = 'block';

            // Activate button
            const activeBtn = document.querySelector(`.tab-btn[onclick="switchSidebarTab('${tabName}')"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.style.borderBottom = '2px solid var(--accent-primary)';
                activeBtn.style.color = 'var(--text-primary)';
            }
        }

        function handleWordRightClick(e) {
            e.preventDefault();
            const selection = window.getSelection();
            selectedWord = selection.toString().trim();
            if (!selectedWord) return;

            const menu = document.getElementById('context-menu');
            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
        }

        document.addEventListener('click', () => {
            document.getElementById('context-menu').style.display = 'none';
        });

        async function lookupWord(type) {
            if (!selectedWord) return;

            // Show AI panel if hidden
            const aiPanel = document.getElementById('ai-panel');
            if (!aiPanel.classList.contains('active')) {
                aiPanel.classList.add('active');
            }

            // Update lookup header
            const header = document.getElementById('lookup-word-header');
            header.textContent = `${type === 'rhyme' ? 'ğŸ¯ Rhymes' : 'ğŸ” Synonyms'} for "${selectedWord}"`;

            // Fetch results
            const res = await fetch(`/api/tools/lookup?word=${encodeURIComponent(selectedWord)}&type=${type}`);
            const data = await res.json();

            // Display in panel
            const resultsDiv = document.getElementById('lookup-results');
            let html = '';

            if (type === 'rhyme') {
                const rhymes = data.results?.perfect || data.results || [];
                if (rhymes.length > 0) {
                    html = `<div class="lookup-tags" style="display:flex; flex-wrap:wrap; gap:0.5rem;">
                    ${rhymes.slice(0, 20).map(r => `<span class="chip" style="cursor:pointer;" onclick="insertWord('${r}')">${r}</span>`).join('')}
                </div>`;
                } else {
                    html = '<p style="color:var(--text-secondary);">No rhymes found.</p>';
                }
            } else {
                const synonyms = data.results?.synonyms || data.results || [];
                if (synonyms.length > 0) {
                    html = `<div class="lookup-tags" style="display:flex; flex-wrap:wrap; gap:0.5rem;">
                    ${synonyms.slice(0, 20).map(s => `<span class="chip" style="cursor:pointer;" onclick="insertWord('${s}')">${s}</span>`).join('')}
                </div>`;
                } else {
                    html = '<p style="color:var(--text-secondary);">No synonyms found.</p>';
                }
            }

            resultsDiv.innerHTML = html;
        }

        function insertWord(word) {
            const input = document.getElementById('new-line-input');
            if (input) {
                input.value += (input.value ? ' ' : '') + word;
                input.focus();
            }
        }

        async function uploadAudio(input) {
            if (!input.files[0]) return;
            const formData = new FormData();
            formData.append('audio_file', input.files[0]);

            const res = await fetch(`/session/${SESSION_ID}/upload_audio`, {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            if (data.success) {
                if (data.detected_bpm > 0) {
                    alert(`Beat uploaded! Auto-detected BPM: ${data.detected_bpm}`);
                }
                location.reload();
            }
        }
    </script>
    {% endblock %}

    {% block extra_js %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://unpkg.com/wavesurfer.js@7"></script>
    <script src="{{ url_for('static', filename='js/waveform_player.js') }}"></script>
    <script src="{{ url_for('static', filename='js/flow_viz.js') }}"></script>
    <script src="{{ url_for('static', filename='js/session.js') }}"></script>
    <script>
        // Init Flow Viz
        const viz = new FlowVisualizer('flow-canvas');
        const linesData = JSON.parse(document.getElementById('lines-data-json').textContent);
        viz.update(linesData);

        // Init Waveform Player if audio exists
        {% if session.audio_path %}
        initWaveformPlayer('waveform-container', '{{ url_for("static", filename=session.audio_path) }}');
        {% endif %}
    </script>
    <script type="application/json" id="lines-data-json">
[
    {% for line in lines %}
    { "syllable_count": {{ line.syllable_count or 0 }} }{% if not loop.last %},{% endif %}
    {% endfor %}
]
</script>
    {% endblock %}
# ═══════════════════════════════════════════════════════════
# VibeLyrics - Docker Compose Configuration
# ═══════════════════════════════════════════════════════════
# Production: docker-compose up -d
# Development: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

services:
  # ─────────────────────────────────────────────────────────
  # Main Application (Backend + Static Frontend)
  # ─────────────────────────────────────────────────────────
  vibelyrics:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: vibelyrics-app
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      # API Keys (from .env file or directly)
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      # Database
      - DATABASE_URL=sqlite+aiosqlite:///./data/vibelyrics.db
      # Redis Cache
      - REDIS_URL=redis://redis:6379/0
      # App Settings
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DEBUG=${DEBUG:-false}
    volumes:
      # Persist database and uploads
      - vibelyrics-data:/app/data
      - vibelyrics-uploads:/app/uploads
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5000/health" ]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3
    networks:
      - vibe-network
    depends_on:
      - redis

  # ─────────────────────────────────────────────────────────
  # Redis Cache (for rhyme lookups and AI responses)
  # ─────────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: vibelyrics-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - vibe-network

# ═══════════════════════════════════════════════════════════
# Named Volumes (for data persistence)
# ═══════════════════════════════════════════════════════════
volumes:
  vibelyrics-data:
    driver: local
  vibelyrics-uploads:
    driver: local
  redis-data:
    driver: local

# ═══════════════════════════════════════════════════════════
# Networks
# ═══════════════════════════════════════════════════════════
networks:
  vibe-network:
    driver: bridge
